{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staff Page</title>
    <link rel="shortcut icon" href="{% static 'assets/favicon-icon.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'css/staff.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

<div class="container">
    <div class="header">
        <img src="{% static 'assets/smartCityLogo.png' %}" alt="Logo">

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search complaints...">
        </div>

        <div class="filterdiv">
            <label for="filtertype">Filter by Department:</label>
            <select id="filtertype" name="category">
                <option selected>Select department</option>
                {% for dep in department %}
                    <option>{{ dep.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="sortdiv">
            <label for="sorttype">Sort by:</label>
            <select id="sorttype">
                <option selected>Default</option>
                <option value="Resolved">Resolved</option>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Reject">Reject</option>
            </select>
        </div>

        <div class="userprofile">
            <i class="fa-solid fa-user"></i>
            <span>Hello {{ user.username }}</span>
        </div>
    </div>

    <div class="content">
        <h2>Complaints Overview</h2>

        {% for dept_name, complaints in department_complaints.items %}
        <div class="department-section">
            <h3>{{ dept_name }}</h3>
            <table class="complaint-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Complainant</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Location</th>
                        <th>After-complaint</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for complaint in complaints %}
                    <tr>
                        <td>{{ complaint.complaint_id }}</td>
                        <td>{{ complaint.user.name }}</td>
                        <td>{{ complaint.description }}</td>
                        <td>{{ complaint.created_at|date:"Y-m-d" }}</td>
                        <td>{{ complaint.location }}</td>
                        <td>
                            {% if complaint.image_url %}
                                <img src="{{ complaint.image_url }}" alt="Complaint Image" style="width: 60px; height: auto;">
                            {% else %}
                                No image
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" action="{% url 'update_complaint_status' complaint.complaint_id %}">
                                {% csrf_token %}
                                <select name="status" onchange="this.form.submit()">
                                    <option value="Pending" {% if complaint.status == 'Pending' %}selected{% endif %}>Pending</option>
                                    <option value="In Progress" {% if complaint.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                    <option value="Resolved" {% if complaint.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                    <option value="Reject" {% if complaint.status == 'Reject' %}selected{% endif %}>Reject</option>
                                </select>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let searchInput = document.querySelector('.search-input');
    let filterSelect = document.getElementById('filtertype');
    let sortSelect = document.getElementById('sorttype');

    function filterTable() {
        let searchText = searchInput.value.toLowerCase();
        let selectedDept = filterSelect.value;
        let selectedStatus = sortSelect.value;

        document.querySelectorAll('.department-section').forEach(section => {
            let sectionTitle = section.querySelector('h3').textContent.trim();
            let showSection = false;

            section.querySelectorAll('tbody tr').forEach(row => {
                let cells = row.querySelectorAll('td');
                let complainant = cells[1].textContent.toLowerCase();
                let description = cells[2].textContent.toLowerCase();
                let statusSelect = cells[6].querySelector('select');
                let statusText = statusSelect ? statusSelect.value : '';


                let matchesSearch = complainant.includes(searchText) || description.includes(searchText);
                let matchesDept = selectedDept === "Select department" || sectionTitle === selectedDept;
                let matchesStatus = selectedStatus === "Default" || statusText === selectedStatus;

                if (matchesSearch && matchesDept && matchesStatus) {
                    row.style.display = '';
                    showSection = true;
                } else {
                    row.style.display = 'none';
                }
            });

            section.style.display = showSection ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterTable);
    filterSelect.addEventListener('change', filterTable);
    sortSelect.addEventListener('change', filterTable);
});
</script>

</body>
</html>
